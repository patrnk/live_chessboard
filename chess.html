<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <img src="img/chessboard.jpg" width=800px height=800px/>
        <br>
        <input type="file" id="game_file"/>
        <br>
        <button id="next_turn_button" disabled>Следующий ход</button>
        <br>
        <label id="turn_description"></label>
        <script>
            var coordinates = []
            var next_turn_button = document.getElementById("next_turn_button");
            var control = document.getElementById("game_file");
            var turn_description = document.getElementById("turn_description");
            var current_turn = 0;

            var get_two_dimensional_array = function(rows, cols) {
                var x = new Array(rows);
                for (var i = 0; i < rows; i++) {
                    x[i] = new Array(cols);
                }
                return x;
            }

            var get_initial_chessboard = function() {
                var chessboard = get_two_dimensional_array(8, 8);
                chessboard[0][0] = {"color": "black", "name": "rook"};
                chessboard[0][7] = {"color": "black", "name": "rook"};
                chessboard[7][0] = {"color": "white", "name": "rook"};
                chessboard[7][7] = {"color": "white", "name": "rook"};
                chessboard[0][1] = {"color": "black", "name": "knight"};
                chessboard[0][6] = {"color": "black", "name": "knight"};
                chessboard[7][1] = {"color": "white", "name": "knight"};
                chessboard[7][6] = {"color": "white", "name": "knight"};
                chessboard[0][2] = {"color": "black", "name": "bishop"};
                chessboard[0][5] = {"color": "black", "name": "bishop"};
                chessboard[7][2] = {"color": "white", "name": "bishop"};
                chessboard[7][5] = {"color": "white", "name": "bishop"};
                chessboard[0][3] = {"color": "black", "name": "king"};
                chessboard[7][3] = {"color": "white", "name": "king"};
                chessboard[0][4] = {"color": "black", "name": "queen"};
                chessboard[7][4] = {"color": "white", "name": "queen"};
                for (var i = 0; i < 8; i++) {
                    chessboard[1][i] = {"color": "black", "name": "pawn"};
                    chessboard[6][i] = {"color": "white", "name": "pawn"};
                }
                return chessboard;
            }

            var render_chessboard = function(chessboard) {
                for (var i = 0; i < 8; i++) {
                    var str = ""
                    for (var j = 0; j < 8; j++) {
                        str += chessboard[i][j] + " ";
                    }
                    console.log(str);
                }
            }

            var chessboard = get_initial_chessboard();

            var convert_cell_to_coordinates = function(turn) {
                // левый верхний угол A8 -> (0,0).
                // (см. chessboard.jpg)
                var letter_number_map = {
                    'A': 0, 'B': 1, 'C': 2, 'D': 3,
                    'E': 4, 'F': 5, 'G': 6
                }
                var column_letter = turn[0];
                var reversed_row = parseInt(turn[1]);
                var column = letter_number_map[column_letter];
                var row = (reversed_row - 8) * (-1);
                return {'row': row, 'col': column};
            }

            var display_next_turn = function() {
                if (current_turn >= coordinates.length) {
                    turn_description.innerText = "Ходы закончились";
                    next_turn_button.disabled = true;
                    return;
                }
                start_row = coordinates[current_turn]["start"]["row"];
                start_col = coordinates[current_turn]["start"]["col"];
                finish_row = coordinates[current_turn]["finish"]["row"];
                finish_col = coordinates[current_turn]["finish"]["col"];
                turn_description.innerText = "(" + start_row + "," + start_col + ")" +
                    " -> (" + finish_row + "," + finish_col + ")";
                chessboard[finish_row][finish_col] = chessboard[start_row][start_col];
                chessboard[start_row][start_col] = undefined;
                render_chessboard(chessboard);
                current_turn += 1;
            }

            var reader = new FileReader();
            reader.onload = function(event) {
                var contents = event.target.result;
                var turns = contents.split("\n"); // ожидается, что каждый новый ход на новой строке
                console.log("Ходы: " + turns);
                for (var i = 0; i < turns.length; i++) {
                    if (!turns[i]) {
                        // Если строка пустая или undefined, пропускаем итерацию
                        continue;
                    }
                    var start_cell = turns[i].split(" ")[0];
                    var finish_cell = turns[i].split(" ")[1];
                    var start_coordinates = convert_cell_to_coordinates(start_cell);
                    var finish_coordinates = convert_cell_to_coordinates(finish_cell);
                    coordinates.push({"start": start_coordinates, "finish": finish_coordinates})
                }
                next_turn_button.disabled = false;
                current_turn = 0;
                display_next_turn();
            }

            next_turn_button.onclick = function(event) {
                display_next_turn();
            }

            var read_file = function(event) {
                var files = control.files;
                var file = files[0]; // гарантированно будет ровно один
                reader.readAsText(file);
            }
            control.addEventListener("change", read_file, false);
        </script>
    </body>
</html>
